<!doctype html>
<html lang="en" id="htmlRoot">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="app.title">Digital Sovereignty Through Open Source</title>
  <meta name="description" content="Global campaign to list service companies that use and contribute to Free and Open Source Software for government digital services. Add your company via Pull Request or GitHub Issue." />

  <!-- Basic, readable system font stack -->
  <style>
    :root {
      --bg: #0b0f14;
      --surface: #121821;
      --text: #f5f7fa;
      --muted: #c6cbd3;
      --accent: #4cc38a; /* green - passes contrast on dark */
      --focus: #ffcc00;  /* high contrast focus outline */
      --error: #ff6b6b;
      --maxw: 72rem;
    }

    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.55;
    }

    .skip-link {
      position: absolute;
      left: -9999px;
    }
    .skip-link:focus {
      left: 0;
      top: 0;
      background: var(--focus);
      color: #000;
      padding: .5rem .75rem;
      z-index: 1000;
    }

    header {
      background: linear-gradient(180deg, #0f1722, #0b0f14);
      border-bottom: 1px solid #1f2937;
      position: relative; /* Added for language switcher positioning */
    }
    .wrap { max-width: var(--maxw); margin: 0 auto; padding: 1rem 1rem 2rem; }
    .hero { padding-top: 2rem; padding-bottom: 1.5rem; }
    h1 { font-size: clamp(1.75rem, 2.5vw, 2.5rem); margin: 0 0 .5rem; }
    p.lede { font-size: 1.125rem; color: var(--muted); margin: 0 0 1rem; }

    .cta {
      display: inline-block;
      background: var(--accent);
      color: #0b0f14;
      text-decoration: none;
      font-weight: 700;
      padding: .75rem 1rem;
      border-radius: .5rem;
      margin-right: .5rem;
    }
    .cta:focus { outline: 3px solid var(--focus); outline-offset: 2px; }

    main { border-top: 1px solid #1f2937; background: var(--surface); }
    section { padding: 2rem 1rem; }
    h2 { font-size: clamp(1.25rem, 2vw, 1.75rem); margin: 0 0 .75rem; }

    .grid { display: grid; gap: 1.25rem; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }

    .card {
      background: #0f141c;
      border: 1px solid #1f2937;
      border-radius: .75rem;
      padding: 1rem;
    }
    .card h3 { margin: 0 0 .5rem; font-size: 1.15rem; }
    .card h3 a { color: var(--text); text-decoration: none; }
    .card h3 a:hover, .card h3 a:focus { color: var(--accent); text-decoration: underline; }
    .card p { margin-bottom: .5rem; }
    .card p:last-child { margin-bottom: 0; }
    .card .links a { color: var(--muted); }

    label { display: block; font-weight: 600; margin-top: .75rem; }
    input[type="text"], input[type="url"], input[type="email"] {
      width: 100%;
      background: #0b0f14;
      color: var(--text);
      border: 1px solid #2a3545;
      border-radius: .5rem;
      padding: .6rem .7rem;
    }
    input:focus { outline: 3px solid var(--focus); outline-offset: 2px; }

    .hint { color: var(--muted); font-size: .95rem; }
    .req { font-weight: 700; }
    .actions { margin-top: 1rem; display: flex; gap: .5rem; flex-wrap: wrap; }
    .button {
      background: var(--accent);
      color: #0b0f14;
      border: 0;
      border-radius: .5rem;
      padding: .7rem 1rem;
      font-weight: 700;
      cursor: pointer;
    }
    .button.secondary { background: transparent; border: 1px solid #2a3545; color: var(--text); }
    .button:focus { outline: 3px solid var(--focus); outline-offset: 2px; }

    .notice { background: #122335; border-left: 4px solid var(--accent); padding: .75rem 1rem; border-radius: .5rem; }

    footer { padding: 2rem 1rem; color: var(--muted); font-size: .95rem; }

    /* Respect user motion preferences */
    @media (prefers-reduced-motion: reduce) {
      html { scroll-behavior: auto; }
    }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to main content</a>

  <header role="banner">
    <div class="wrap hero">
      <h1 data-i18n="app.title">Digital Sovereignty Through Open Source</h1>
      <p class="lede" data-i18n="app.tagline">We are building a global list of service companies that use and contribute to Free and Open Source Software for government digital services. Contribute your company by Pull Request or GitHub Issue.</p>
      <p class="lede" data-i18n="app.description">Open innovation enables governments to adapt, experiment, and avoid lock-in. Collaboration is essential to healthy democracies. Public code strengthens digital public goods.</p>
      <div class="actions" aria-label="Primary actions">
        <a id="prLink" class="cta" href="#form" data-i18n="nav.add_company">Add your company</a>
        <a id="issueLinkTop" class="cta" href="#form" data-i18n="nav.create_issue">Create a GitHub Issue</a>
      </div>
    </div>
  </header>

  <main id="main" role="main">
    <div class="wrap">
      <section aria-labelledby="how">
        <h2 id="how" data-i18n="contribute.title">How to contribute</h2>
        <div class="grid">
          <div class="card">
            <ol>
              <li data-i18n="contribute.step1">Fork the repository.</li>
              <li data-i18n="contribute.step2">Add your company to the <code>companies.csv</code> file and submit a Pull Request.</li>
              <li data-i18n="contribute.step3">Or, create a GitHub Issue with the same details using the form below.</li>
            </ol>
            <p class="hint" data-i18n="contribute.merit_notice">No ads, no pay-to-play. Listing is merit based and focused on real FOSS contributions to digital public goods.</p>
          </div>
          <div class="card">
            <p class="notice" role="note" data-i18n="contribute.data_notice">This page does not collect or store form data. The form below generates a prefilled GitHub Issue link or PR payload for you to submit to the repository.</p>
          </div>
        </div>
      </section>

      <section aria-labelledby="form">
        <h2 id="form" data-i18n="form.title">Generate your submission</h2>
        <form id="companyForm" class="card" novalidate aria-describedby="formHelp">
          <p id="formHelp" class="hint" data-i18n="form.required_notice">Fields marked with <span class="req" aria-label="required">*</span> are required.</p>

          <label for="name" data-i18n="form.name">Company name <span class="req">*</span></label>
          <input id="name" name="name" type="text" autocomplete="organization" required />

          <label for="english" data-i18n="form.english">English alternative (if applicable)</label>
          <input id="english" name="english" type="text" />

          <label for="website" data-i18n="form.website">Website <span class="req">*</span></label>
          <input id="website" name="website" type="url" inputmode="url" placeholder="https://example.org" required />

          <label for="email" data-i18n="form.email">Info email</label>
          <input id="email" name="email" type="email" inputmode="email" placeholder="info@example.org" />

          <label for="linkedin" data-i18n="form.linkedin">LinkedIn profile</label>
          <input id="linkedin" name="linkedin" type="url" inputmode="url" placeholder="https://www.linkedin.com/company/..." />

          <label for="github" data-i18n="form.github">GitHub profile</label>
          <input id="github" name="github" type="url" inputmode="url" placeholder="https://github.com/your-org" />

          <label for="otherRepo" data-i18n="form.other_repo">Other public Git repository</label>
          <input id="otherRepo" name="otherRepo" type="url" inputmode="url" placeholder="https://gitlab.com/your-org" />

          <div class="actions">
            <button type="button" class="button" id="buildIssue" data-i18n="form.build_issue">Build GitHub Issue</button>
            <button type="button" class="button secondary" id="buildCsvRow" data-i18n="form.build_csv">Build CSV row for PR</button>
          </div>

          <div id="errorSummary" class="notice" role="alert" aria-live="polite" hidden></div>
          <div id="output" class="card" aria-live="polite" hidden></div>
        </form>
      </section>

      <section aria-labelledby="companies">
        <h2 id="companies" data-i18n="companies.title">Listed Companies</h2>
        <div id="company-list" class="grid">
          <p data-i18n="companies.loading">Loading companies...</p>
        </div>
      </section>

      <section aria-labelledby="criteria">
        <h2 id="criteria" data-i18n="criteria.title">Listing criteria</h2>
        <ul>
          <li data-i18n="criteria.item1">Active use of FOSS in delivery of government digital services.</li>
          <li data-i18n="criteria.item2">Documented contributions to upstream projects. Examples include merged pull requests, maintainership, or financial support with transparency.</li>
          <li data-i18n="criteria.item3">Clear governance and security practices. Preference for OSI-approved licenses.</li>
        </ul>
      </section>
    </div>
  </main>

  <footer role="contentinfo">
    <div class="wrap">
      <p data-i18n="footer.privacy">Built for openness and speed. No trackers. No cookies.</p>
      <p data-i18n="footer.accessibility">Keyboard tips: Tab to move focus. Shift+Tab to go back. Enter to activate buttons and links.</p>
    </div>
  </footer>

  <!-- Add YAML library for parsing language files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
  
  <!-- Load fallback translations -->
  <script src="translations.js"></script>
  
  <!-- Load internationalization script -->
  <script src="i18n.js"></script>
  
  <script>
    // Configuration - set your repository here
    const REPO_OWNER = "mgifford";
    const REPO_NAME  = "foss4gov";

    const issueUrlBase = (owner, repo) => `https://github.com/${owner}/${repo}/issues/new`;

    function encodeIssue(fields) {
      // This will use translations from the i18n system
      const translations = window.i18n.currentTranslations() || {};
      
      // Format LinkedIn and GitHub URLs
      const formattedLinkedIn = formatLinkedIn(fields.linkedin);
      const formattedGitHub = formatGitHub(fields.github);
      
      // Safe access to translations with fallbacks
      const title = (translations.issue?.title || 'Add {name} to FOSS4Gov').replace('{name}', fields.name);
      const bodyLines = [
        translations.issue?.company_details || 'Company Details:',
        `- Name: ${fields.name}`,
        fields.english ? `- English alternative: ${fields.english}` : null,
        `- Website: ${fields.website}`,
        fields.email ? `- Info email: ${fields.email}` : null,
        formattedLinkedIn ? `- LinkedIn: ${formattedLinkedIn}` : null,
        formattedGitHub ? `- GitHub: ${formattedGitHub}` : null,
        fields.otherRepo ? `- Other public Git repo: ${fields.otherRepo}` : null,
        "\n" + (translations.issue?.confirmation || 'Confirmation:'),
        translations.issue?.confirmation_text || 'I confirm this company meets the requirements for inclusion.'
      ].filter(Boolean).join("\n");

      const params = new URLSearchParams({
        title,
        body: bodyLines
      });
      return params.toString();
    }

    function prYamlLine(key, val) {
      return val ? `${key}: "${val.replace(/"/g, '\\"')}"` : "";
    }
    
    // Helper functions to format social media URLs
    function formatLinkedIn(url) {
      if (!url) return "";
      
      // If it's already a full URL, return it
      if (url.match(/^https?:\/\//i)) return url;
      
      // If it's just a username/profile, add the proper prefix
      if (url.match(/^[a-zA-Z0-9-]+$/)) {
        return `https://linkedin.com/in/${url}`;
      }
      
      // If it starts with 'linkedin.com', add https://
      if (url.match(/^linkedin\.com/i)) {
        return `https://${url}`;
      }
      
      return url;
    }
    
    function formatGitHub(url) {
      if (!url) return "";
      
      // If it's already a full URL, return it
      if (url.match(/^https?:\/\//i)) return url;
      
      // If it's just a username, add the proper prefix
      if (url.match(/^[a-zA-Z0-9-]+$/)) {
        return `https://github.com/${url}`;
      }
      
      // If it starts with 'github.com', add https://
      if (url.match(/^github\.com/i)) {
        return `https://${url}`;
      }
      
      return url;
    }
    
    function buildCsvRow(fields) {
      // Helper to quote and escape existing quotes for a CSV field
      const csvSafe = (str) => `"${(str || '').replace(/"/g, '""')}"`;
      
      // Format LinkedIn and GitHub URLs
      const formattedLinkedIn = formatLinkedIn(fields.linkedin);
      const formattedGitHub = formatGitHub(fields.github);
      
      return [
        csvSafe(fields.name),
        csvSafe(fields.english),
        csvSafe(fields.website),
        csvSafe(fields.email),
        csvSafe(formattedLinkedIn),
        csvSafe(formattedGitHub),
        csvSafe(fields.otherRepo)
      ].join(',');
    }

    function buildDataYaml(fields) {
      // Format LinkedIn and GitHub URLs
      const formattedLinkedIn = formatLinkedIn(fields.linkedin);
      const formattedGitHub = formatGitHub(fields.github);
      
      // Minimal YAML-ready block a contributor can drop into a data file
      const lines = [
        "-",
        prYamlLine("  name", fields.name),
        prYamlLine("  english_name", fields.english || ""),
        prYamlLine("  website", fields.website),
        prYamlLine("  info_email", fields.email || ""),
        prYamlLine("  linkedin", formattedLinkedIn || ""),
        prYamlLine("  github", formattedGitHub || ""),
        prYamlLine("  other_repo", fields.otherRepo || "")
      ].filter(Boolean);
      return lines.join("\n");
    }

    function setError(msg) {
      const translations = window.i18n.currentTranslations() || {};
      const el = document.getElementById("errorSummary");
      el.hidden = false;
      el.textContent = msg || translations.form?.validation?.required_fields || 'Please fill in all required fields';
    }

    function clearError() {
      const el = document.getElementById("errorSummary");
      el.hidden = true;
      el.textContent = "";
    }

    function getFields() {
      return {
        name: document.getElementById("name").value.trim(),
        english: document.getElementById("english").value.trim(),
        website: document.getElementById("website").value.trim(),
        email: document.getElementById("email").value.trim(),
        linkedin: document.getElementById("linkedin").value.trim(),
        github: document.getElementById("github").value.trim(),
        otherRepo: document.getElementById("otherRepo").value.trim()
      };
    }

    function validate(fields) {
      // Require company name and website, and website must be a valid URL
      if (!fields.name || !fields.website) {
        setError(window.i18n.currentTranslations()?.form?.validation?.required_fields || 'Company name and Website are required.');
        return false;
      }
      
      // Add https:// prefix if missing from website URL
      if (!fields.website.match(/^https?:\/\//)) {
        fields.website = 'https://' + fields.website;
        document.getElementById("website").value = fields.website;
      }
      
      // Validate website URL
      try {
        new URL(fields.website);
      } catch {
        setError(window.i18n.currentTranslations()?.form?.validation?.invalid_url || 'Please enter a valid URL.');
        return false;
      }
      
      // Validate email if provided
      if (fields.email && !fields.email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        setError('Please enter a valid email address.');
        return false;
      }
      
      clearError();
      return true;
    }

    function buildIssueLink(fields) {
      const q = encodeIssue(fields);
      const url = `${issueUrlBase(REPO_OWNER, REPO_NAME)}?${q}`;
      return url;
    }
    
    // This function is now moved to i18n.js since it needs to handle translations
    // We're keeping a reference here for compatibility
    async function loadCompanies() {
      // This will call the version in i18n.js
      await window.i18n.loadCompanies();
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize internationalization first
      window.i18n.initI18n();
      
      // Load the company list on page load
      window.i18n.loadCompanies();
      
      // Debug info in console
      console.log('Page fully loaded with i18n support');
      console.log('Current language:', window.i18n.currentLanguage ? window.i18n.currentLanguage : 'Unknown');
      console.log('Current translations:', window.i18n.currentTranslations ? 'Translations loaded' : 'No translations');
      console.log('Available languages:', Object.keys(LANGUAGES).join(', '));
      
      // Attach all event listeners after the DOM is ready
      document.getElementById("buildIssue").addEventListener("click", () => {
        const fields = getFields();
        if (!validate(fields)) return;
          const url = buildIssueLink(fields);
          const out = document.getElementById("output");
          out.hidden = false;
          const translations = window.i18n.currentTranslations() || {};
          const issueLinkLabel = translations.form?.output?.issue_link || 'GitHub Issue Link:';
          out.innerHTML = `<p><strong>${issueLinkLabel}</strong><br><a href="${url}">${url}</a></p>`;
          document.getElementById("issueLinkTop").href = url;
        });

        document.getElementById("buildCsvRow").addEventListener("click", () => {
          const fields = getFields();
          if (!validate(fields)) return;
          const csvRow = buildCsvRow(fields);
          const out = document.getElementById("output");
          out.hidden = false;
          const csvRowLabel = getTranslation('form.output.csv_row') || 'CSV Row:';
          out.innerHTML = `<p><strong>${csvRowLabel}</strong></p><pre><code>${csvRow}</code></pre>`;
        });

        // Set top links to go to contribute section by default
        document.getElementById("prLink").href = "#form";
        document.getElementById("issueLinkTop").href = "#form";
    });
  </script>