<!doctype html>
<html lang="en" id="htmlRoot">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="app.title">Digital Sovereignty Through Open Source</title>
  <meta name="description" content="Global campaign to list service companies that use and contribute to Free and Open Source Software for government digital services. Add your company via Pull Request or GitHub Issue." />

  <!-- Basic, readable system font stack -->
  <style>
    :root {
      /* Dark theme (default) */
      --bg: #0b0f14;
      --surface: #121821;
      --text: #f5f7fa;
      --muted: #c6cbd3;
      --accent: #4cc38a; /* green - passes contrast on dark */
      --focus: #ffcc00;  /* high contrast focus outline */
      --error: #ff6b6b;
      --border: #1f2937;
      --card-bg: #0f141c;
      --header-gradient-start: #0f1722;
      --header-gradient-end: #0b0f14;
      --border-dark: #2a3545;
      --notice-bg: #122335;
      --maxw: 72rem;
    }
    
    /* Light theme */
    :root[data-theme="light"] {
      --bg: #f5f7fa;
      --surface: #ffffff;
      --text: #121821;
      --muted: #4a5568;
      --accent: #38a169; /* darker green for better contrast on light */
      --focus: #2b6cb0; /* blue focus for light mode */
      --error: #e53e3e;
      --border: #e2e8f0;
      --card-bg: #f0f4f8;
      --header-gradient-start: #e6edf5;
      --header-gradient-end: #f5f7fa;
      --border-dark: #cbd5e0;
      --notice-bg: #ebf8ff;
      --maxw: 72rem;
    }

    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.55;
    }

    .skip-link {
      position: absolute;
      left: -9999px;
    }
    .skip-link:focus {
      left: 0;
      top: 0;
      background: var(--focus);
      color: #000;
      padding: .5rem .75rem;
      z-index: 1000;
    }

    header {
      background: linear-gradient(180deg, var(--header-gradient-start), var(--header-gradient-end));
      border-bottom: 1px solid var(--border);
      position: relative; /* Added for language switcher positioning */
    }
    .wrap { max-width: var(--maxw); margin: 0 auto; padding: 1rem 1rem 2rem; }
    .hero { padding-top: 2rem; padding-bottom: 1.5rem; }
    h1 { font-size: clamp(1.75rem, 2.5vw, 2.5rem); margin: 0 0 .5rem; }
    p.lede { font-size: 1.125rem; color: var(--muted); margin: 0 0 1rem; }

    .cta {
      display: inline-block;
      background: var(--accent);
      color: #0b0f14;
      text-decoration: none;
      font-weight: 700;
      padding: .75rem 1rem;
      border-radius: .5rem;
      margin-right: .5rem;
      text-align: center;
    }
    .cta:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      text-decoration: underline;
    }
    .cta:focus { 
      outline: 3px solid var(--focus); 
      outline-offset: 2px; 
      text-decoration: underline;
    }
    .cta:active {
      transform: translateY(1px);
    }

    main { border-top: 1px solid var(--border); background: var(--surface); }
    section { padding: 2rem 1rem; }
    h2 { font-size: clamp(1.25rem, 2vw, 1.75rem); margin: 0 0 .75rem; }

    .grid { display: grid; gap: 1.25rem; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: .75rem;
      padding: 1rem;
      box-sizing: border-box;
      width: 100%;
      overflow: hidden; /* Prevent content from overflowing */
    }
    .card h3 { margin: 0 0 .5rem; font-size: 1.15rem; }
    .card h3 a { 
      color: var(--text); 
      text-decoration: none; 
      display: inline-block;
      padding: 0.1rem 0.2rem;
      margin: -0.1rem -0.2rem;
      border-radius: 0.25rem;
    }
    .card h3 a:hover, .card h3 a:focus { 
      color: var(--accent); 
      text-decoration: underline; 
    }
    .card h3 a:focus {
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }
    .card p { margin-bottom: .5rem; }
    .card p:last-child { margin-bottom: 0; }
    .card .links a { 
      color: var(--muted); 
      text-decoration: underline;
      padding: 0.1rem 0.2rem;
      border-radius: 0.25rem;
    }
    .card .links a:hover {
      color: var(--text);
    }
    .card .links a:focus {
      outline: 3px solid var(--focus);
      outline-offset: 2px;
      color: var(--text);
    }

    label { 
      display: block; 
      font-weight: 600; 
      margin-top: .75rem; 
      margin-bottom: 0.25rem;
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
      max-width: 100%;
    }
    
    #companyForm {
      max-width: 100%;
      box-sizing: border-box;
    }
    
    input[type="text"], input[type="url"], input[type="email"] {
      width: 100%;
      box-sizing: border-box;
      background: var(--bg);
      color: var(--text);
      border: 2px solid var(--border-dark);
      border-radius: .5rem;
      padding: .6rem .7rem;
      font-size: 1rem;
      line-height: 1.5;
      margin-bottom: 0.25rem;
    }
    input:focus { 
      outline: 3px solid var(--focus); 
      outline-offset: 2px; 
      border-color: var(--accent);
    }
    input::placeholder {
      color: var(--muted);
      opacity: 0.7;
    }

    .hint { color: var(--muted); font-size: .95rem; }
    .req { font-weight: 700; }
    .actions { margin-top: 1rem; display: flex; gap: .5rem; flex-wrap: wrap; }
    
    /* Improved error handling styles */
    #errorSummary {
      background-color: #ffeded;
      border-left: 4px solid var(--error);
      padding: 1rem;
      margin: 1.5rem 0;
      border-radius: 0.25rem;
    }
    
    /* Responsive form layout */
    @media (max-width: 480px) {
      label {
        font-size: 0.95rem;
      }
      
      #companyForm {
        padding: 0.75rem;
      }
    }
    
    #errorSummary:focus {
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }
    
    #errorSummary.has-error {
      animation: errorPulse 0.5s ease-out;
    }
    
    .error-heading {
      color: var(--error);
      margin-top: 0;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }
    
    /* Add animation for error messages */
    @keyframes errorPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    
    /* Better styles for the output area */
    #output {
      margin-top: 1.5rem;
      padding: 1rem;
      background-color: var(--card-bg);
      border-radius: 0.25rem;
    }
    
    #output:focus {
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }
    
    .output-link {
      word-break: break-all;
      display: inline-block;
      margin-top: 0.5rem;
    }
    .button {
      background: var(--accent);
      color: #0b0f14;
      border: 0;
      border-radius: .5rem;
      padding: .7rem 1rem;
      font-weight: 700;
      cursor: pointer;
      text-decoration: none; /* For links styled as buttons */
      display: inline-block; /* For links styled as buttons */
      text-align: center; /* For links styled as buttons */
    }
    .button.secondary { 
      background: transparent; 
      border: 1px solid var(--border-dark); 
      color: var(--text); 
    }
    .button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .button:focus { 
      outline: 3px solid var(--focus); 
      outline-offset: 2px; 
      text-decoration: underline;
    }
    .button:active {
      transform: translateY(1px);
    }

    .notice { background: var(--notice-bg); border-left: 4px solid var(--accent); padding: .75rem 1rem; border-radius: .5rem; }

    footer { padding: 2rem 1rem; color: var(--muted); font-size: .95rem; }
    .footer-link { color: var(--muted); text-decoration: underline; }
    .footer-link:hover, .footer-link:focus { color: var(--accent); }
    .a11y-info { border-top: 1px solid var(--border); padding-top: 1rem; margin-top: 1rem; }

    /* Respect user motion preferences */
    @media (prefers-reduced-motion: reduce) {
      html { scroll-behavior: auto; }
    }
    
    /* Theme toggle styles */
    .theme-toggle {
      position: absolute;
      top: 1rem;
      right: 1rem;
      z-index: 110; /* above language switcher */
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text);
      font-size: 1.25rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      padding: 0; /* Remove default button padding */
      outline: none; /* Remove default button outline */
    }
    
    .theme-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .theme-toggle:focus {
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }
    
    /* Adjust language switcher position to make room for theme toggle */
    .lang-switcher {
      top: 1rem;
      right: 4rem !important;
    }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to main content</a>

  <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark/light mode">
    <span id="theme-toggle-icon">☀️</span>
  </button>

  <header role="banner">
    <div class="wrap hero">
      <h1 data-i18n="app.title">Digital Sovereignty Through Open Source</h1>
      <p class="lede" data-i18n="app.tagline">We are building a global list of service companies that use and contribute to Free and Open Source Software for government digital services. Contribute your company by Pull Request or GitHub Issue.</p>
      <p class="lede" data-i18n="app.description">Open innovation enables governments to adapt, experiment, and avoid lock-in. Collaboration is essential to healthy democracies. Public code strengthens digital public goods.</p>
      <div class="actions" aria-label="Primary actions">
        <a id="prLink" class="cta" href="#form" data-i18n="nav.add_company">Add your company</a>
        <a id="issueLinkTop" class="cta" href="#form" data-i18n="nav.create_issue">Create a GitHub Issue</a>
      </div>
    </div>
  </header>

  <main id="main" role="main">
    <div class="wrap">
      <section aria-labelledby="how">
        <h2 id="how" data-i18n="contribute.title">How to contribute</h2>
        <div class="grid">
          <div class="card">
            <ol>
              <li data-i18n="contribute.step1">Fork the repository.</li>
              <li data-i18n="contribute.step2">Add your company to the <code>companies.csv</code> file and submit a Pull Request.</li>
              <li data-i18n="contribute.step3">Or, create a GitHub Issue with the same details using the form below.</li>
            </ol>
            <p class="hint" data-i18n="contribute.merit_notice">No ads, no pay-to-play. Listing is merit based and focused on real FOSS contributions to digital public goods.</p>
          </div>
          <div class="card">
            <p class="notice" role="note" data-i18n="contribute.data_notice">This page does not collect or store form data. The form below generates a prefilled GitHub Issue link or PR payload for you to submit to the repository.</p>
          </div>
        </div>
      </section>

      <section aria-labelledby="form">
        <h2 id="form" data-i18n="form.title">Generate your submission</h2>
        <form id="companyForm" class="card" novalidate aria-describedby="formHelp">
          <p id="formHelp" class="hint" data-i18n="form.required_notice">Fields marked with <span class="req" aria-label="required">*</span> are required.</p>

          <label for="name" data-i18n="form.name">Company name <span class="req">*</span></label>
          <input id="name" name="name" type="text" autocomplete="organization" required />

          <label for="english" data-i18n="form.english">English alternative (if applicable)</label>
          <input id="english" name="english" type="text" />

          <label for="website" data-i18n="form.website">Website <span class="req">*</span></label>
          <input id="website" name="website" type="url" inputmode="url" placeholder="https://example.org" required />

          <label for="email" data-i18n="form.email">Info email</label>
          <input id="email" name="email" type="email" inputmode="email" placeholder="info@example.org" />

          <label for="linkedin" data-i18n="form.linkedin">LinkedIn profile</label>
          <input id="linkedin" name="linkedin" type="url" inputmode="url" placeholder="https://www.linkedin.com/company/..." />

          <label for="github" data-i18n="form.github">GitHub profile</label>
          <input id="github" name="github" type="url" inputmode="url" placeholder="https://github.com/your-org" />

          <label for="otherRepo" data-i18n="form.other_repo">Other public Git repository</label>
          <input id="otherRepo" name="otherRepo" type="url" inputmode="url" placeholder="https://gitlab.com/your-org" />

          <div class="actions">
            <button type="button" class="button" id="buildIssue" data-i18n="form.build_issue">Build GitHub Issue</button>
            <button type="button" class="button secondary" id="buildCsvRow" data-i18n="form.build_csv">Build CSV row for PR</button>
          </div>

          <div id="errorSummary" class="notice" role="alert" aria-live="assertive" tabindex="-1" hidden></div>
          <div id="output" class="card" aria-live="polite" tabindex="-1" hidden></div>
        </form>
      </section>

      <section aria-labelledby="companies">
        <h2 id="companies" data-i18n="companies.title">Listed Companies</h2>
        <div id="company-list" class="grid">
          <p data-i18n="companies.loading">Loading companies...</p>
        </div>
      </section>

      <section aria-labelledby="criteria">
        <h2 id="criteria" data-i18n="criteria.title">Listing criteria</h2>
        <ul>
          <li data-i18n="criteria.item1">Active use of FOSS in delivery of government digital services.</li>
          <li data-i18n="criteria.item2">Documented contributions to upstream projects. Examples include merged pull requests, maintainership, or financial support with transparency.</li>
          <li data-i18n="criteria.item3">Clear governance and security practices. Preference for OSI-approved licenses.</li>
        </ul>
      </section>
    </div>
  </main>

  <footer role="contentinfo">
    <div class="wrap">
      <p data-i18n="footer.privacy">Built for openness and speed. No trackers. No cookies.</p>
      <p data-i18n="footer.accessibility">Keyboard tips: Tab to move focus. Shift+Tab to go back. Enter to activate buttons and links.</p>
      <p class="a11y-info"><span data-i18n="footer.a11y_info">This site aims to meet WCAG 2.2 AA standards with proper keyboard navigation, focus indicators, color contrast, and screen reader support.</span> <a href="https://github.com/mgifford/foss4gov/issues" class="footer-link" data-i18n="footer.report_issues">Report accessibility issues</a>.</p>
    </div>
  </footer>

  <!-- Add YAML library for parsing language files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
  
  <!-- Load fallback translations -->
  <script src="translations.js"></script>
  
  <!-- Load internationalization script -->
  <script src="i18n.js"></script>
  
  <!-- Theme switcher functionality -->
  <script>
    // Theme switching functionality
    (function() {
      const themeToggle = document.getElementById('theme-toggle');
      const themeToggleIcon = document.getElementById('theme-toggle-icon');
      const htmlRoot = document.getElementById('htmlRoot');
      const DARK_THEME = 'dark';
      const LIGHT_THEME = 'light';
      const THEME_STORAGE_KEY = 'foss4gov-theme-preference';
      
      // Check for saved theme preference or use browser default
      function getPreferredTheme() {
        const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
        if (savedTheme) {
          return savedTheme;
        }
        // Check browser preference
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? DARK_THEME : LIGHT_THEME;
      }
      
      // Apply theme
      function applyTheme(theme) {
        if (theme === LIGHT_THEME) {
          htmlRoot.setAttribute('data-theme', LIGHT_THEME);
          themeToggleIcon.textContent = '🌙'; // Moon for light mode (to switch to dark)
          themeToggle.setAttribute('aria-label', 'Switch to dark mode');
          themeToggle.setAttribute('title', 'Switch to dark mode');
        } else {
          htmlRoot.removeAttribute('data-theme');
          themeToggleIcon.textContent = '☀️'; // Sun for dark mode (to switch to light)
          themeToggle.setAttribute('aria-label', 'Switch to light mode');
          themeToggle.setAttribute('title', 'Switch to light mode');
        }
      }
      
      // Initialize theme
      function initTheme() {
        const theme = getPreferredTheme();
        applyTheme(theme);
      }
      
      // Toggle theme
      function toggleTheme() {
        const currentTheme = htmlRoot.getAttribute('data-theme') === LIGHT_THEME ? LIGHT_THEME : DARK_THEME;
        const newTheme = currentTheme === DARK_THEME ? LIGHT_THEME : DARK_THEME;
        
        applyTheme(newTheme);
        localStorage.setItem(THEME_STORAGE_KEY, newTheme);
      }
      
      // Set up event listeners
      if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
        // Add keyboard support
        themeToggle.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleTheme();
          }
        });
      }
      
      // Initialize theme on page load
      initTheme();
      
      // Update theme if browser preference changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem(THEME_STORAGE_KEY)) {
          applyTheme(e.matches ? DARK_THEME : LIGHT_THEME);
        }
      });
    })();
  </script>
  
  <script>
    // Configuration - set your repository here
    const REPO_OWNER = "mgifford";
    const REPO_NAME  = "foss4gov";

    const issueUrlBase = (owner, repo) => `https://github.com/${owner}/${repo}/issues/new`;

    function encodeIssue(fields) {
      // This will use translations from the i18n system
      const translations = window.i18n.currentTranslations() || {};
      
      // Format LinkedIn and GitHub URLs
      const formattedLinkedIn = formatLinkedIn(fields.linkedin);
      const formattedGitHub = formatGitHub(fields.github);
      
      // Generate CSV format for the issue
      const csvRow = [
        fields.name,
        fields.english || "",
        fields.website,
        fields.email || "",
        formattedLinkedIn || "",
        formattedGitHub || "",
        fields.otherRepo || ""
      ].join(", ");
      
      // Safe access to translations with fallbacks
      const title = (translations.issue?.title || 'Add {name} to FOSS4Gov').replace('{name}', fields.name);
      const bodyLines = [
        translations.issue?.company_details || 'Company Details:',
        `- Name: ${fields.name}`,
        fields.english ? `- English alternative: ${fields.english}` : null,
        `- Website: ${fields.website}`,
        fields.email ? `- Info email: ${fields.email}` : null,
        formattedLinkedIn ? `- LinkedIn: ${formattedLinkedIn}` : null,
        formattedGitHub ? `- GitHub: ${formattedGitHub}` : null,
        fields.otherRepo ? `- Other public Git repo: ${fields.otherRepo}` : null,
        "\n" + (translations.issue?.confirmation || 'Confirmation:'),
        translations.issue?.confirmation_text || 'I confirm this company meets the requirements for inclusion.',
        "\n" + "CSV Format:",
        "```",
        csvRow,
        "```"
      ].filter(Boolean).join("\n");

      const params = new URLSearchParams({
        title,
        body: bodyLines
      });
      return params.toString();
    }

    function prYamlLine(key, val) {
      return val ? `${key}: "${val.replace(/"/g, '\\"')}"` : "";
    }
    
    // Helper functions to format social media URLs
    function formatLinkedIn(url) {
      if (!url) return "";
      
      // If it's already a full URL, return it
      if (url.match(/^https?:\/\//i)) return url;
      
      // If it's just a username/profile, add the proper prefix
      if (url.match(/^[a-zA-Z0-9-]+$/)) {
        return `https://linkedin.com/in/${url}`;
      }
      
      // If it starts with 'linkedin.com', add https://
      if (url.match(/^linkedin\.com/i)) {
        return `https://${url}`;
      }
      
      return url;
    }
    
    function formatGitHub(url) {
      if (!url) return "";
      
      // If it's already a full URL, return it
      if (url.match(/^https?:\/\//i)) return url;
      
      // If it's just a username, add the proper prefix
      if (url.match(/^[a-zA-Z0-9-]+$/)) {
        return `https://github.com/${url}`;
      }
      
      // If it starts with 'github.com', add https://
      if (url.match(/^github\.com/i)) {
        return `https://${url}`;
      }
      
      return url;
    }
    
    function buildCsvRow(fields) {
      // Helper to quote and escape existing quotes for a CSV field
      const csvSafe = (str) => `"${(str || '').replace(/"/g, '""')}"`;
      
      // Format LinkedIn and GitHub URLs
      const formattedLinkedIn = formatLinkedIn(fields.linkedin);
      const formattedGitHub = formatGitHub(fields.github);
      
      return [
        csvSafe(fields.name),
        csvSafe(fields.english),
        csvSafe(fields.website),
        csvSafe(fields.email),
        csvSafe(formattedLinkedIn),
        csvSafe(formattedGitHub),
        csvSafe(fields.otherRepo)
      ].join(',');
    }

    function buildDataYaml(fields) {
      // Format LinkedIn and GitHub URLs
      const formattedLinkedIn = formatLinkedIn(fields.linkedin);
      const formattedGitHub = formatGitHub(fields.github);
      
      // Minimal YAML-ready block a contributor can drop into a data file
      const lines = [
        "-",
        prYamlLine("  name", fields.name),
        prYamlLine("  english_name", fields.english || ""),
        prYamlLine("  website", fields.website),
        prYamlLine("  info_email", fields.email || ""),
        prYamlLine("  linkedin", formattedLinkedIn || ""),
        prYamlLine("  github", formattedGitHub || ""),
        prYamlLine("  other_repo", fields.otherRepo || "")
      ].filter(Boolean);
      return lines.join("\n");
    }

    function setError(msg) {
      const translations = window.i18n.currentTranslations() || {};
      const el = document.getElementById("errorSummary");
      el.hidden = false;
      // Use an error heading for better screen reader announcement
      const errorHeading = translations.form?.validation?.error_heading || 'Form Error:';
      el.innerHTML = `<h3 class="error-heading">${errorHeading}</h3><p>${msg || translations.form?.validation?.required_fields || 'Please fill in all required fields'}</p>`;
      // Set focus to the error message for immediate feedback
      el.focus();
      // Add error class to help with styling
      el.classList.add('has-error');
    }

    function clearError() {
      const el = document.getElementById("errorSummary");
      el.hidden = true;
      el.innerHTML = "";
      el.classList.remove('has-error');
    }

    function getFields() {
      return {
        name: document.getElementById("name").value.trim(),
        english: document.getElementById("english").value.trim(),
        website: document.getElementById("website").value.trim(),
        email: document.getElementById("email").value.trim(),
        linkedin: document.getElementById("linkedin").value.trim(),
        github: document.getElementById("github").value.trim(),
        otherRepo: document.getElementById("otherRepo").value.trim()
      };
    }

    function validate(fields) {
      // Require company name and website, and website must be a valid URL
      if (!fields.name || !fields.website) {
        setError(window.i18n.currentTranslations()?.form?.validation?.required_fields || 'Company name and Website are required.');
        return false;
      }
      
      // Handle URL fields by automatically adding https:// prefix if missing
      ['website', 'linkedin', 'github', 'otherRepo'].forEach(field => {
        if (fields[field] && fields[field].trim() !== '') {
          // If URL doesn't start with http:// or https://, add https://
          if (!fields[field].match(/^https?:\/\//i)) {
            fields[field] = 'https://' + fields[field];
            // Update the input field with the corrected URL
            document.getElementById(field).value = fields[field];
          }
        }
      });
      
      // Validate website URL
      try {
        new URL(fields.website);
      } catch {
        setError(window.i18n.currentTranslations()?.form?.validation?.invalid_url || 'Please enter a valid URL.');
        return false;
      }
      
      // Validate email if provided
      if (fields.email && !fields.email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        const emailError = window.i18n.currentTranslations()?.form?.validation?.invalid_email || 'Please enter a valid email address.';
        setError(emailError);
        return false;
      }
      
      clearError();
      return true;
    }

    function buildIssueLink(fields) {
      const q = encodeIssue(fields);
      const url = `${issueUrlBase(REPO_OWNER, REPO_NAME)}?${q}`;
      return url;
    }
    
    // This function is now moved to i18n.js since it needs to handle translations
    // We're keeping a reference here for compatibility
    async function loadCompanies() {
      // This will call the version in i18n.js
      await window.i18n.loadCompanies();
    }

    // Add proper keyboard interaction for all interactive elements
    document.addEventListener('DOMContentLoaded', () => {
      // Make sure all focusable elements have proper keyboard interaction
      const focusableElements = document.querySelectorAll('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])');
      focusableElements.forEach(el => {
        // If the element doesn't already have a keydown listener for accessibility
        if (!el.hasAttribute('data-keyboard-accessible')) {
          el.setAttribute('data-keyboard-accessible', 'true');
          
          // Only add for elements that don't already have key handlers
          if (el.tagName !== 'INPUT' && el.tagName !== 'TEXTAREA' && el.tagName !== 'SELECT') {
            el.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' || e.key === ' ') {
                if (el.tagName === 'A' && e.key === ' ') {
                  e.preventDefault();
                  el.click();
                } else if (el.tagName === 'BUTTON' || el.getAttribute('role') === 'button') {
                  e.preventDefault();
                  el.click();
                }
              }
            });
          }
        }
      });
      
      // Initialize internationalization first
      window.i18n.initI18n();
      
      // Load the company list on page load
      window.i18n.loadCompanies();
      
      // Debug info in console
      console.log('Page fully loaded with i18n support');
      console.log('Current language:', window.i18n.currentLanguage ? window.i18n.currentLanguage : 'Unknown');
      console.log('Current translations:', window.i18n.currentTranslations ? 'Translations loaded' : 'No translations');
      console.log('Available languages:', Object.keys(LANGUAGES).join(', '));
      
      // Attach all event listeners after the DOM is ready
      // Function to handle the issue link generation
      function handleBuildIssue() {
        const fields = getFields();
        if (!validate(fields)) return;
        const url = buildIssueLink(fields);
        const out = document.getElementById("output");
        out.hidden = false;
        const translations = window.i18n.currentTranslations() || {};
        const issueLinkLabel = translations.form?.output?.issue_link || 'GitHub Issue Link:';
        out.innerHTML = `<p><strong>${issueLinkLabel}</strong><br><a href="${url}" class="output-link">${url}</a></p>`;
        document.getElementById("issueLinkTop").href = url;
        // Move focus to the output for screen readers
        out.focus();
      }

      // Function to handle CSV row generation
      function handleBuildCsvRow() {
        const fields = getFields();
        if (!validate(fields)) return;
        const csvRow = buildCsvRow(fields);
        const out = document.getElementById("output");
        out.hidden = false;
        const csvRowLabel = getTranslation('form.output.csv_row') || 'CSV Row:';
        out.innerHTML = `<p><strong>${csvRowLabel}</strong></p><pre><code>${csvRow}</code></pre>`;
        // Move focus to the output for screen readers
        out.focus();
      }

      // Add click event listeners
      document.getElementById("buildIssue").addEventListener("click", handleBuildIssue);
      document.getElementById("buildCsvRow").addEventListener("click", handleBuildCsvRow);

      // Add keyboard event listeners for accessibility
      document.getElementById("buildIssue").addEventListener("keydown", function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          handleBuildIssue();
        }
      });

      document.getElementById("buildCsvRow").addEventListener("keydown", function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          handleBuildCsvRow();
        }
      });

        // Set top links to go to contribute section by default
        document.getElementById("prLink").href = "#form";
        document.getElementById("issueLinkTop").href = "#form";
    });
  </script>